---
title: Shell expectç”¨æ³•æè¿°
tags:
  - Shell
  - Expect
categories:
  - æœåŠ¡å™¨ç®¡ç†
date: 2022-07-01 12:01:01
thumbnail:
---
## 1. expect è‡ªåŠ¨åŒ–äº¤äº’è„šæœ¬

### 1.1. ä»‹ç»

expectæ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒ–äº¤äº’å¥—ä»¶ï¼Œä¸»è¦åº”ç”¨äºæ‰§è¡Œå‘½ä»¤å’Œç¨‹åºæ—¶ï¼Œç³»ç»Ÿä»¥äº¤äº’å½¢å¼è¦æ±‚è¾“å…¥æŒ‡å®šå­—ç¬¦ä¸²ï¼Œå®ç°äº¤äº’é€šä¿¡ã€‚

### 1.2. å®‰è£…

```sh
sudo apt-get update
sudo apt-get install expect
```

### 1.3. å‘½ä»¤ä»‹ç»

Expectä¸­æœ€å…³é”®çš„å››ä¸ªå‘½ä»¤æ˜¯send,expect,spawn,interactã€‚

- sendï¼šå‘è¿›ç¨‹å‘é€å­—ç¬¦ä¸²ï¼Œç”¨äºæ¨¡æ‹Ÿç”¨æˆ·çš„è¾“å…¥ï¼Œ è¯¥å‘½ä»¤ä¸èƒ½è‡ªåŠ¨å›è½¦æ¢è¡Œï¼Œä¸€èˆ¬è¦åŠ \rï¼ˆå›è½¦ï¼‰

- expectï¼š expectçš„ä¸€ä¸ªå†…éƒ¨å‘½ä»¤ï¼Œåˆ¤æ–­ä¸Šæ¬¡è¾“å‡ºç»“æœé‡Œæ˜¯å¦åŒ…å«æŒ‡å®šçš„å­—ç¬¦ä¸²ï¼Œå¦‚æœæœ‰åˆ™ç«‹å³è¿”å›ï¼Œå¦åˆ™å°±ç­‰å¾…è¶…æ—¶æ—¶é—´åè¿”å›ï¼Œåªèƒ½æ•æ‰ç”±spawnå¯åŠ¨çš„è¿›ç¨‹çš„è¾“å‡ºexpect

- spawnï¼šå¯åŠ¨è¿›ç¨‹ï¼Œå¹¶è·Ÿè¸ªåç»­äº¤äº’ä¿¡æ¯

- interactï¼šæ‰§è¡Œå®Œæˆåä¿å­˜äº¤äº’çŠ¶æ€ï¼ŒæŠŠæ§åˆ¶æƒäº¤ç»™æ§åˆ¶å°

- set timeout 30ï¼šè®¾ç½®è¶…æ—¶æ—¶é—´ä¸º30ç§’(é»˜è®¤çš„è¶…æ—¶æ—¶é—´æ˜¯ 10 ç§’ï¼Œé€šè¿‡ set å‘½ä»¤å¯ä»¥è®¾ç½®ä¼šè¯è¶…æ—¶æ—¶é—´, è‹¥ä¸é™åˆ¶è¶…æ—¶æ—¶é—´åˆ™åº”è®¾ç½®ä¸º-1)

- exp_continueï¼š å…è®¸expectç»§ç»­å‘ä¸‹æ‰§è¡ŒæŒ‡ä»¤meoutï¼šæŒ‡å®šè¶…æ—¶æ—¶é—´ï¼Œè¿‡æœŸåˆ™ç»§ç»­æ‰§è¡Œåç»­æŒ‡ä»¤

- send_userï¼š å›æ˜¾å‘½ä»¤ï¼Œç›¸å½“äºecho

- `$argv`å‚æ•°æ•°ç»„ï¼šExpectè„šæœ¬å¯ä»¥æ¥å—ä»bashä¼ é€’çš„å‚æ•°ï¼Œå¯ä»¥ä½¿ç”¨ [lindex `$argv` n] è·å¾—ï¼Œnä»0å¼€å§‹ï¼Œåˆ†åˆ«è¡¨ç¤ºç¬¬ä¸€ä¸ª`$1`ï¼Œç¬¬äºŒä¸ª`$2`ï¼Œç¬¬ä¸‰ä¸ª`$3`â€¦â€¦å‚æ•° (`$argvn`æ²¡æœ‰ç©ºæ ¼åˆ™è¡¨ç¤ºè„šæœ¬åç§° ï¼› `$argv` næœ‰ç©ºæ ¼åˆ™ä»£è¡¨ä¸‹æ ‡)

ä¸€èˆ¬æµç¨‹ï¼šspawn å¯åŠ¨è¿½è¸ª â€”> expect åŒ¹é…æ•æ‰å…³é”®å­— â€”â€”> æ•æ‰åˆ°å°†è§¦å‘send ä»£æ›¿äººä¸ºè¾“å…¥æŒ‡ä»¤â€”> interact /expect eof

Expectè„šæœ¬å¿…é¡»ä»¥interactæˆ–expect eof ç»“æŸï¼Œæ‰§è¡Œè‡ªåŠ¨åŒ–ä»»åŠ¡é€šå¸¸expect eofå°±å¤Ÿäº†

expect eof æ˜¯åœ¨ç­‰å¾…ç»“æŸæ ‡å¿—ã€‚ç”±spawnå¯åŠ¨çš„å‘½ä»¤åœ¨ç»“æŸæ—¶ä¼šäº§ç”Ÿä¸€ä¸ªeofæ ‡è®°ï¼Œexpect eof å³åœ¨ç­‰å¾…è¿™ä¸ªæ ‡è®°

### 1.4. bash shellå†…åŠ å…¥expectè„šæœ¬

ä½¿ç”¨`<<-EOF` ï¼Œå¼•å…¥expectè„šæœ¬ã€‚

```shell
#!/bin/base
/usr/bin/expect <<-EOF

EOF
```



## 2. äº‹ä¾‹

### 2.1. ssh è¿æ¥è¿œç«¯æœåŠ¡å™¨

1). å¼€å§‹æ„å»ºæ–‡ä»¶

```sh
vi test_expect.exp
```

2). æ„å»ºæ–‡ä»¶å†…å®¹

```sh
#!/usr/bin/expect
# ä¼ å…¥å‚æ•°æ•°é‡éªŒè¯
if {$argc < 3} {
    #do something
    send_user "usage: $argv0 <remote_user> <remote_host> <remote_pwd>"
    exit
}

// å°†è¶…æ—¶è®¾ç½®ä¸º-1ä»¥ç¦ç”¨è¶…æ—¶åŠŸèƒ½ã€‚
set timeout -1

# è¿œç¨‹æœåŠ¡å™¨ç”¨æˆ·å
set remote_user [lindex $argv 0] 
# è¿œç¨‹æœåŠ¡å™¨åŸŸå
set remote_host [lindex $argv 1] 
# è¿œç¨‹æœåŠ¡å™¨å¯†ç 
set remote_pwd [lindex $argv 2]

# è¿œç¨‹ç™»å½•
spawn ssh ${remote_user}@${remote_host}
expect {
    "*password" {send "${remote_pwd}\r";}
    "*yes/no" {send "yes\r";exp_continue}
}
# sshç™»é™†æˆåŠŸåï¼Œç»§ç»­è¿›è¡Œæ“ä½œã€‚
expect "]#" { send "cd /\r" }
# ç»“æŸ
expect eof
```

3). ä½¿ç”¨è„šæœ¬

```sh
./test_expect.exp username ip password
```

## ğŸŒŸ æ³¨æ„äº‹é¡¹

- è„šæœ¬æ–‡ä»¶å†…å®¹ç¬¬ä¸€è¡Œå¿…é¡»åŠ å…¥`#!/usr/bin/expect`ã€‚
- expect è„šæœ¬æ–‡ä»¶æ‰§è¡Œå¿…é¡»ä½¿ç”¨ ./test_expect.expã€‚
